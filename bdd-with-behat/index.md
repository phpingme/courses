---
 head:
  title: "BDD with Behat"
 commands:
   - vendor/bin/behat
---

## Introduction

To develop a software is always about managing a lot of moving parts. And pretty often it gets messy, in a way that even a developer who wrote the code, cannot recover what is going on after 2-3 weeks the code was shipped.  It is an old problem and had a range of mature concepts around that helps to deal with in a sufficient way. Here we will try a BDD, and show how we can control a software's feature set and move quickly forwards using behat.



## Write Feature and Scenarios
The concept of **Feature** in BDD let us focus on a specific problem from a perspective of certain customer.  To describe this problem in a Feature form we need to provide 2 things:
 - Feature inroduction
 - Scenario

### Feature introduction
To introduce a Feature we use quite the same pattern we apply to describe a user story, namely:
```html
   In order to <achieve a goal>
   As <the stakeholder who wants the goal>
   I want <something>
```
For a developer the 3'd line is most likely always clear, it handles an outcome of implementation, like *Product could be ordered*, *Post has hidden comments*... But it's not always clear about first two lines, especially if stuff have to be implemented in a microservice scope, where a customer could be less personalizable.
Here is important to work with PO and apply a [Ubiquitous Language](http://martinfowler.com/bliki/UbiquitousLanguage.html) of a domain you are implementing.

### Scenario
**Scenario** is an essential part of the whole BDD process, they are the part that describe a behaviour of our software. Each Scenario follows the following *Given-When-Then* schema:
```html
  Given <initial state>
  When <apply a change to the state>
  Then <verify a changed state>
```

To start to write Features, let's first initiate environment where we want to write it.

```sh
    vendor/bin/behat --init
```

it creates a following tree structure:
```
```

Now let's create a first feature ```features/course.feature```(you can do it with a write click on **features** folder) with a first Scenario:
```
Feature: Course
  In order to learn about programming
  As a trainee
  I want pass a programming course

 Scenario: Pass the Task
   Given there is a task to find factorial of "5"
   When a solution is equal to "120"
   Then i passed the task
```



> An actual Task, write the second scenario that checks the use case when the factorial task is not passed.


```projecteditor+terminal
---
match_file:
  path: features/course.feature
  match:
   - (Then.*t.*pass)
---
```

## Implementing test first

After we define our feature that describes a constraints of a factorial task. Lets implement a test for it and take an advantage of behat as well.
First of all, we need to convert our feature in a PHP form. For that, let's run:
```sh
  vendor/bin/behat --append-snippets
```
Out of 6 steps we get 4 methods in **features/bootstrap/FeatureContext.php**, that throws a **Pending** exception, where each method is responsible for a concrete one line in a Scenario.
We have to have the same *Given* and *Then* descriptions in both of our Scenarios, that's why behat apply the same methods in **FeatureContext** class for them, the only that is variable are arguments and that will be passed in as a method parameters.
And we have two different *When*, for them we get another to methods that have to separately check task passing or non passing.

To start implement the test, let's create an empty **Factorial** class in an application root. And make it look like this:
```php
<?php
// path: /Factorial.php

class Factorial {

	public function __invoke() {

	}

}

```


Try to run behat again, just execute ```vendor/bin/behat```, and see on STDOUT, it has to look smth. like this:
```
2 scenarios (2 pending)
6 steps (2 pending, 4 skipped)
```

First we want to do is resolve pending steps. To achieve it, we need to overwrite ```throw new PendingException();``` in our autogenerated ```features/bootstrap/FeatureContext.php``` with a real implementation. Let's start with the first method ```thereIsATaskToFindFactorialOf``` for a first **Given** step and put a code like this:
```php
<?php
...

    /**
     * @Given there is a task to find factorial of :arg1
     */
    public function thereIsATaskToFindFactorialOf($arg1)
    {
        $this->input = $arg1;
    }
```

Then we go to the following **When** step, controlled by ```theSolutionIs``` method, that can be implemented like this:
```php
  /**
   * @When a solution is equal to :arg1
   */
  public function aSolutionIsEqualTo($arg1)
  {
      $this->isEqual = ($arg1 === (new Factorial())($this->input));
  }
```

And now the the most nice part, checking whether the app we build run, the way we expect it. We will do it in a php7 way a take usage of ```assert()``` function(it needs an extra ```ini_set('assert.exception', 1)```).
```php
   /**
    * @Then i passed the task
    */
   public function iPassedTheTask()
   {
       ini_set('assert.exception', 1);
       assert($this->isEqual, new AssertionError('Factorial return a wrong result'));
   }
```
and for negotiation case:
```php
   /**
    * @Then i didn't pass the task
    */
   public function iPassedTheTask()
   {
       ini_set('assert.exception', 1);
       assert(!$this->isEqual, new AssertionError('Factorial have to return a proper result'));
   }
```

let's try to run it, the output now, have to look like this:
```
2 scenarios (1 passed, 1 failed)
6 steps (5 passed, 1 failed)
```

And as you see from 2 Scenarios, we have 1 that already pass. It's kinda freaky to see that smth. working without we implement anything, but from outside perspective it just right that factorial ships wrong results.

> It's quite obvious step that is still open, namely implementation of a factorial. To pass this course step, implement a Factorial and run behat in order to check that both from out 2 scenarios are passing.

```projecteditor+terminal
---
match_output:
  match:
   - (2 scenarios (2 passed,)
---
```

## Applying Scenario Outline



## Config


## Conclusion

It was a first filling of BDD in php, if you noticed some inconsistency in this course you a free to make a PR to this course on github.com/phpingme/courses
